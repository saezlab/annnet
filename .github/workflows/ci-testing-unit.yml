name: CI testing [unit testing]

on: [push, pull_request]

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
        -   uses: actions/checkout@v4
        -   uses: ./.github/actions/setup
            with:
                python-version: '3.13'
        -   name: Run Ruff (lint + formatting + import order)
            run: .venv/bin/ruff check .
        -   name: Run Ruff format check (like Black)
            run: .venv/bin/ruff format --check .

    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ['3.11', '3.12', '3.13']
        steps:
        -   uses: actions/checkout@v4
        -   uses: ./.github/actions/setup
            with:
                python-version: ${{ matrix.python-version }}
        -   name: Install optional test dependencies
            shell: bash
            run: |
                source .venv/bin/activate
                uv pip install networkx zarr numcodecs pyarrow python-igraph
        -   name: Run tests with coverage
            run: |
                source .venv/bin/activate
                pytest --cov=annnet tests/
        -   name: Upload coverage report
            uses: actions/upload-artifact@v4
            with:
                name: coverage-report-${{ matrix.python-version }}
                path: .coverage*

    pixi-test-all:
        runs-on: ubuntu-latest
        steps:
        -   uses: actions/checkout@v4
        -   uses: prefix-dev/setup-pixi@v0.9.3
            with:
                environments: dev
                cache: true
        -   name: Run tests including graph-tool
            run: pixi run test-all
